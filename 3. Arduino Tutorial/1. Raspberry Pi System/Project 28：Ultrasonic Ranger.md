**Project 28：Ultrasonic Ranger**

1.  **Introduction**
    
    The HC-SR04 ultrasonic sensor is a very affordable distance sensor,
    which mainly used for obstacle avoidance in various robotic
    projects. It is also used for water level sensing and even as a
    parking sensor. In this project, we use a ESP32 to control an
    ultrasonic sensor and LEDs to simulate ultrasonic rangefinder.

2.  **Components**

<table>
<tbody>
<tr class="odd">
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Raspberry-Pi/master/media/56053f7126905c6def63919c661d5c0a.jpeg" style="width:1.59722in;height:0.77986in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Raspberry-Pi/master/media/e380dd26e4825be9a768973802a55fe6.png" style="width:0.75972in;height:1.8625in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Raspberry-Pi/master/media/85df6831220dec7d43a68bfc9b7382cb.png" style="width:1.45764in;height:0.96319in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Raspberry-Pi/master/media/7eb361d680dfa351f07f8527aeb37abd.png" style="width:0.275in;height:1.17361in" /></td>
<td></td>
</tr>
<tr class="even">
<td>ESP32*1</td>
<td>Breadboard*1</td>
<td>Ultrasonic Sensor*1</td>
<td>Red LED*4</td>
<td></td>
</tr>
<tr class="odd">
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Raspberry-Pi/master/media/1fbdfe0569327d9a42600a54336bf7b5.png" style="width:1.38819in;height:1.15833in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Raspberry-Pi/master/media/098a2730d0b0a2a4b2079e0fc87fd38b.png" style="width:1.22639in;height:0.49236in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Raspberry-Pi/master/media/e9a8d050105397bb183512fb4ffdd2f6.png" style="width:0.90694in;height:0.90139in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Raspberry-Pi/master/media/7dcbd02995be3c142b2f97df7f7c03ce.png" style="width:0.99028in;height:0.52986in" /></td>
<td></td>
</tr>
<tr class="even">
<td>M-F Dupont Wires</td>
<td>220ΩResistor*4</td>
<td>Jumper Wires</td>
<td>USB Cable*1</td>
<td></td>
</tr>
</tbody>
</table>

3.  **Component Knowledge**

**HC-SR04 Ultrasonic Sensor :** Like bats, it uses sonar to determine
the distance to an object. It provides accurate non-contact range
detection, high-precision and stable readings. Its operation is not
affected by sunlight or black materials, just like a precision camera
(acoustically softer materials like cloth are difficult to detect). It
has an ultrasonic transmitter and a receiver.

![](/media/e6f6037071e434febf7090b56ac35802.png)

There are two metal cylinders in front of the ultrasonic sensor, which
are converters. The converters empower to convert the mechanical energy
into electrical signals. Furthermore, a transmitting converters and a
receiving converter are contained in the ultrasonic sensor. The
transmitting converter converts the electronic signals into an
ultrasonic pulse, and the receiving converter converts the reflected
ultrasonic pulse back to the electronic signals.

If you look at the back of the ultrasonic sensor, you will see an IC
behind the transmitting converter, which enables to control the
transmitting converter. There is also an IC behind the receiving
converter, which is a quad operational amplifier that amplifies the
signal generated by the receiving converter into a signal large enough
to be transmitted to the microcontroller.

**Sequence diagram**

The figure shows the sequence diagram of the HC-SR04. In order to start
the measurement, the trig of the SR04 must receive at least 10us high
pulse (5V), which will activate the sensor to emit 8 cycles of 40kHz
ultrasonic pulses, and wait for the reflected ultrasonic pulses.

When the sensor detects ultrasonic from the receiver, it will set the
Echo pin to high (5V) and delays it by one cycle (width), which is
proportional to the distance. We must measure the width of the Echo pin
if we are to get the distance.

![](/media/4114885ac4b6214953e3224d8c1d52c4.png)

Time = Echo pulse width, its unit is “us” (microseconds)

Distance in centimeters = time / 58

Distance in inches = time / 148

4.  **Read the ultrasonic sensor**
    
    We will start with a simple ultrasonic ranging and print the
    measured distance.
    
    ![](/media/db430baa07e2e4d9ac9efca1950b953a.jpeg)
    
    The HC-SR04 ultrasonic sensor has four pins, which are Vcc, Trig,
    Echo and GND. The Vcc pin provides the power for generating
    ultrasonic pulses and is connected to Vcc (+5V). The GND pin is
    grounded.
    
    The Trig pin is where the control board sends a signal to start the
    ultrasonic pulse. The Echo pin is where the ultrasonic sensor sends
    information about the duration of the ultrasonic pulse to the the
    control board.

![](/media/a8d408be3629a2d288dbb30bd60007af.png)

<table>
<tbody>
<tr class="odd">
<td><p>//**********************************************************************************</p>
<p>/*</p>
<p>* Filename : Ultrasonic Ranging</p>
<p>* Description : Use the ultrasonic module to measure the distance.</p>
<p>* Auther : http//www.keyestudio.com</p>
<p>*/</p>
<p>const int TrigPin = 13; // define TrigPin</p>
<p>const int EchoPin = 14; // define EchoPin.</p>
<p>int duration = 0; // Define the initial value of the duration to be 0</p>
<p>int distance = 0;//Define the initial value of the distance to be 0</p>
<p>void setup()</p>
<p></p>
<p>void loop()</p>
<p></p>
<p>//**********************************************************************************</p></td>
</tr>
</tbody>
</table>

Compile and upload the code to ESP32, after the code is uploaded
successfully, power up with a USB cable, open the serial monitor and set
the baud rate to 115200 and press the reset button first. You will see
that the monitor will print out the distance between the ultrasonic
sensor and the object.

![](/media/4927b524b1ceb2647d886c3797245fa5.png)

5.  **Wiring diagram of the ultrasonic rangefinder**
    
    Next, we will use a ESP32 to control an ultrasonic sensor and 4 LEDs
    to simulate ultrasonic rangefinder.
    
    ![](/media/910ed1be8be94411a090afb95af86d1a.png)

6.  **Test Code**

<table>
<tbody>
<tr class="odd">
<td><p>//**********************************************************************************</p>
<p>/*</p>
<p>* Filename : Ultrasonic Ranger</p>
<p>* Description : four leds are controlled by ultrasonic ranging.</p>
<p>* Auther : http//www.keyestudio.com</p>
<p>*/</p>
<p>const int TrigPin = 13; // define TrigPin</p>
<p>const int EchoPin = 14; // define EchoPin.</p>
<p>const int PIN_LED1 = 4; // define PIN_LED1</p>
<p>const int PIN_LED2 = 0; // define PIN_LED2</p>
<p>const int PIN_LED3 = 2; // define PIN_LED3</p>
<p>const int PIN_LED4 = 15; // define PIN_LED4</p>
<p>int duration = 0; // define the initial value of the duration to be 0</p>
<p>int distance = 0; // define the initial value of the distance to be 0</p>
<p>void setup()</p>
<p></p>
<p>void loop()</p>
<p></p>
<p>else</p>
<p></p>
<p>if ( distance &lt;= 10 )</p>
<p></p>
<p>else</p>
<p></p>
<p>if ( distance &lt;= 15 )</p>
<p></p>
<p>else</p>
<p></p>
<p>if ( distance &lt;= 20 )</p>
<p></p>
<p>else</p>
<p></p>
<p>}</p>
<p>//**********************************************************************************</p></td>
</tr>
</tbody>
</table>

7.  **Test Result**

Compile and upload the code to ESP32, after the code is uploaded
successfully, power up with a USB cable, open the serial monitor and set
the baud rate to 115200. You will see that the monitor will print out
the distance between the ultrasonic sensor and the object, and the
corresponding LED will light up when we move our hand in front of the
ultrasonic sensor.
